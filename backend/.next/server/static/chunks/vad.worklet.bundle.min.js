(()=>{"use strict";var e={428:(e,i,o)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.FrameProcessor=i.validateOptions=i.defaultFrameProcessorOptions=void 0;let a=o(294),h=o(842),l=[512,1024,1536];i.defaultFrameProcessorOptions={positiveSpeechThreshold:.5,negativeSpeechThreshold:.35,preSpeechPadFrames:1,redemptionFrames:8,frameSamples:1536,minSpeechFrames:3},i.validateOptions=function(e){l.includes(e.frameSamples)||h.log.warn("You are using an unusual frame size"),(e.positiveSpeechThreshold<0||e.negativeSpeechThreshold>1)&&h.log.error("postiveSpeechThreshold should be a number between 0 and 1"),(e.negativeSpeechThreshold<0||e.negativeSpeechThreshold>e.positiveSpeechThreshold)&&h.log.error("negativeSpeechThreshold should be between 0 and postiveSpeechThreshold"),e.preSpeechPadFrames<0&&h.log.error("preSpeechPadFrames should be positive"),e.redemptionFrames<0&&h.log.error("preSpeechPadFrames should be positive")};let n=e=>{let i=e.reduce((e,i)=>(e.push(e.at(-1)+i.length),e),[0]),o=new Float32Array(i.at(-1));return e.forEach((e,a)=>{let h=i[a];o.set(e,h)}),o};i.FrameProcessor=class{constructor(e,i,o){this.modelProcessFunc=e,this.modelResetFunc=i,this.options=o,this.speaking=!1,this.redemptionCounter=0,this.active=!1,this.reset=()=>{this.speaking=!1,this.audioBuffer=[],this.modelResetFunc(),this.redemptionCounter=0},this.pause=()=>{this.active=!1,this.reset()},this.resume=()=>{this.active=!0},this.endSegment=()=>{let e=this.audioBuffer;this.audioBuffer=[];let i=this.speaking;this.reset();let o=e.reduce((e,i)=>e+ +i.isSpeech,0);if(i){if(o>=this.options.minSpeechFrames){let i=n(e.map(e=>e.frame));return{msg:a.Message.SpeechEnd,audio:i}}return{msg:a.Message.VADMisfire}}return{}},this.process=async e=>{if(!this.active)return{};let i=await this.modelProcessFunc(e);if(this.audioBuffer.push({frame:e,isSpeech:i.isSpeech>=this.options.positiveSpeechThreshold}),i.isSpeech>=this.options.positiveSpeechThreshold&&this.redemptionCounter&&(this.redemptionCounter=0),i.isSpeech>=this.options.positiveSpeechThreshold&&!this.speaking)return this.speaking=!0,{probs:i,msg:a.Message.SpeechStart};if(i.isSpeech<this.options.negativeSpeechThreshold&&this.speaking&&++this.redemptionCounter>=this.options.redemptionFrames){this.redemptionCounter=0,this.speaking=!1;let e=this.audioBuffer;if(this.audioBuffer=[],e.reduce((e,i)=>e+ +i.isSpeech,0)>=this.options.minSpeechFrames){let o=n(e.map(e=>e.frame));return{probs:i,msg:a.Message.SpeechEnd,audio:o}}return{probs:i,msg:a.Message.VADMisfire}}if(!this.speaking)for(;this.audioBuffer.length>this.options.preSpeechPadFrames;)this.audioBuffer.shift();return{probs:i}},this.audioBuffer=[],this.reset()}}},14:function(e,i,o){var a=this&&this.__createBinding||(Object.create?function(e,i,o,a){void 0===a&&(a=o);var h=Object.getOwnPropertyDescriptor(i,o);h&&!("get"in h?!i.__esModule:h.writable||h.configurable)||(h={enumerable:!0,get:function(){return i[o]}}),Object.defineProperty(e,a,h)}:function(e,i,o,a){void 0===a&&(a=o),e[a]=i[o]}),h=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),l=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&a(i,e,o);return h(i,e),i},p=this&&this.__exportStar||function(e,i){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(i,o)||a(i,e,o)};Object.defineProperty(i,"__esModule",{value:!0}),i.utils=void 0;let c=l(o(26));i.utils={minFramesForTargetMS:c.minFramesForTargetMS,arrayBufferToBase64:c.arrayBufferToBase64,encodeWAV:c.encodeWAV},p(o(405),i),p(o(428),i),p(o(294),i),p(o(842),i),p(o(260),i),p(o(724),i)},842:(e,i)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.log=i.LOG_PREFIX=void 0,i.LOG_PREFIX="[VAD]";let o=["error","debug","warn"].reduce((e,o)=>(e[o]=(...e)=>{console[o](i.LOG_PREFIX,...e)},e),{});i.log=o},294:(e,i)=>{var o;Object.defineProperty(i,"__esModule",{value:!0}),i.Message=void 0,(o=i.Message||(i.Message={})).AudioFrame="AUDIO_FRAME",o.SpeechStart="SPEECH_START",o.VADMisfire="VAD_MISFIRE",o.SpeechEnd="SPEECH_END"},260:(e,i,o)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.Silero=void 0;let a=o(842);let r=class r{constructor(e,i){this.ort=e,this.modelFetcher=i,this.init=async()=>{a.log.debug("initializing vad");let e=await this.modelFetcher();this._session=await this.ort.InferenceSession.create(e),this._sr=new this.ort.Tensor("int64",[16000n]),this.reset_state(),a.log.debug("vad is initialized")},this.reset_state=()=>{let e=Array(128).fill(0);this._h=new this.ort.Tensor("float32",e,[2,1,64]),this._c=new this.ort.Tensor("float32",e,[2,1,64])},this.process=async e=>{let i={input:new this.ort.Tensor("float32",e,[1,e.length]),h:this._h,c:this._c,sr:this._sr},o=await this._session.run(i);this._h=o.hn,this._c=o.cn;let[a]=o.output.data;return{notSpeech:1-a,isSpeech:a}}}};i.Silero=r,r.new=async(e,i)=>{let o=new r(e,i);return await o.init(),o}},405:(e,i,o)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.PlatformAgnosticNonRealTimeVAD=i.defaultNonRealTimeVADOptions=void 0;let a=o(428),h=o(294),l=o(260),p=o(724);i.defaultNonRealTimeVADOptions={...a.defaultFrameProcessorOptions},i.PlatformAgnosticNonRealTimeVAD=class{static async _new(e,o,a={}){let h=new this(e,o,{...i.defaultNonRealTimeVADOptions,...a});return await h.init(),h}constructor(e,i,o){this.modelFetcher=e,this.ort=i,this.options=o,this.init=async()=>{let e=await l.Silero.new(this.ort,this.modelFetcher);this.frameProcessor=new a.FrameProcessor(e.process,e.reset_state,{frameSamples:this.options.frameSamples,positiveSpeechThreshold:this.options.positiveSpeechThreshold,negativeSpeechThreshold:this.options.negativeSpeechThreshold,redemptionFrames:this.options.redemptionFrames,preSpeechPadFrames:this.options.preSpeechPadFrames,minSpeechFrames:this.options.minSpeechFrames}),this.frameProcessor.resume()},this.run=async function*(e,i){let o,a;let l={nativeSampleRate:i,targetSampleRate:16e3,targetFrameSize:this.options.frameSamples},c=new p.Resampler(l).process(e);for(let e of[...Array(c.length)].keys()){let i=c[e],{msg:l,audio:p}=await this.frameProcessor.process(i);switch(l){case h.Message.SpeechStart:o=e*this.options.frameSamples/16;break;case h.Message.SpeechEnd:a=(e+1)*this.options.frameSamples/16,yield{audio:p,start:o,end:a}}}let{msg:u,audio:d}=this.frameProcessor.endSegment();u==h.Message.SpeechEnd&&(yield{audio:d,start:o,end:c.length*this.options.frameSamples/16})},(0,a.validateOptions)(o)}}},724:(e,i,o)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.Resampler=void 0;let a=o(842);i.Resampler=class{constructor(e){this.options=e,this.process=e=>{let i=[];for(let i of e)this.inputBuffer.push(i);for(;this.inputBuffer.length*this.options.targetSampleRate/this.options.nativeSampleRate>this.options.targetFrameSize;){let e=new Float32Array(this.options.targetFrameSize),o=0,a=0;for(;o<this.options.targetFrameSize;){let i=0,h=0;for(;a<Math.min(this.inputBuffer.length,(o+1)*this.options.nativeSampleRate/this.options.targetSampleRate);)i+=this.inputBuffer[a],h++,a++;e[o]=i/h,o++}this.inputBuffer=this.inputBuffer.slice(a),i.push(e)}return i},e.nativeSampleRate<16e3&&a.log.error("nativeSampleRate is too low. Should have 16000 = targetSampleRate <= nativeSampleRate"),this.inputBuffer=[]}}},26:(e,i)=>{function s(e,i,o){for(var a=0;a<o.length;a++)e.setUint8(i+a,o.charCodeAt(a))}Object.defineProperty(i,"__esModule",{value:!0}),i.encodeWAV=i.arrayBufferToBase64=i.minFramesForTargetMS=void 0,i.minFramesForTargetMS=function(e,i,o=16e3){return Math.ceil(e*o/1e3/i)},i.arrayBufferToBase64=function(e){for(var i="",o=new Uint8Array(e),a=o.byteLength,h=0;h<a;h++)i+=String.fromCharCode(o[h]);return btoa(i)},i.encodeWAV=function(e,i=3,o=16e3,a=1,h=32){var l=h/8,p=a*l,c=new ArrayBuffer(44+e.length*l),u=new DataView(c);return s(u,0,"RIFF"),u.setUint32(4,36+e.length*l,!0),s(u,8,"WAVE"),s(u,12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,i,!0),u.setUint16(22,a,!0),u.setUint32(24,o,!0),u.setUint32(28,o*p,!0),u.setUint16(32,p,!0),u.setUint16(34,h,!0),s(u,36,"data"),u.setUint32(40,e.length*l,!0),1===i?function(e,i,o){for(var a=0;a<o.length;a++,i+=2){var h=Math.max(-1,Math.min(1,o[a]));e.setInt16(i,h<0?32768*h:32767*h,!0)}}(u,44,e):function(e,i,o){for(var a=0;a<o.length;a++,i+=4)e.setFloat32(i,o[a],!0)}(u,44,e),c}}},i={};(()=>{let o=function s(o){var a=i[o];if(void 0!==a)return a.exports;var h=i[o]={exports:{}};return e[o].call(h.exports,h,h.exports,s),h.exports}(14);let t=class t extends AudioWorkletProcessor{constructor(e){super(),this._initialized=!1,this.init=async()=>{o.log.debug("initializing worklet"),this.resampler=new o.Resampler({nativeSampleRate:sampleRate,targetSampleRate:16e3,targetFrameSize:this.options.frameSamples}),this._initialized=!0,o.log.debug("initialized worklet")},this.options=e.processorOptions,this.init()}process(e,i,a){let h=e[0][0];if(this._initialized&&h instanceof Float32Array){let e=this.resampler.process(h);for(let i of e)this.port.postMessage({message:o.Message.AudioFrame,data:i.buffer},[i.buffer])}return!0}};registerProcessor("vad-helper-worklet",t)})()})();